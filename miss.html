<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>APEX • Missions Test</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.14.0/dist/ethers.umd.min.js"></script>
  <style>
    :root{
      --bg:#05070b; --panel:#0b0f17; --card:#0b101a;
      --stroke:#152037; --text:#e9eefc; --muted:#9fb0d0;
      --blue:#2d6cff; --green:#19d38b; --red:#ff4d4d; --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(45,108,255,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(25,211,139,.10), transparent 60%),
        linear-gradient(180deg,#04060a,#05070b 50%,#04060a);
      padding:18px;
    }
    .wrap{max-width:920px; margin:0 auto}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background:rgba(11,16,26,.78);
      border:1px solid rgba(21,32,55,.75);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      position:sticky; top:12px; backdrop-filter:blur(10px); z-index:10;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand b{letter-spacing:1px}
    .brand small{color:rgba(159,176,208,.8); font-weight:700}
    .btn{
      border:1px solid rgba(99,163,255,.25);
      background:rgba(11,16,26,.62);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
      transition:.12s ease;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(99,163,255,.45)}
    .btn.primary{background:linear-gradient(135deg,rgba(45,108,255,1),rgba(99,163,255,1)); border-color:transparent}
    .btn.danger{border-color:rgba(255,77,77,.25); background:rgba(255,77,77,.10)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(11,16,26,.78);
      border:1px solid rgba(21,32,55,.75);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card h3{margin:0 0 10px; letter-spacing:2px; color:rgba(159,176,208,.92); font-size:13px; text-transform:uppercase}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(21,32,55,.85);
      background:rgba(8,10,14,.55);
      font-weight:900; letter-spacing:.6px; font-size:12px;
      color:rgba(233,238,252,.88);
    }
    .pill.ok{border-color:rgba(25,211,139,.25); background:rgba(25,211,139,.08); color:rgba(25,211,139,.95)}
    .pill.no{opacity:.55}
    .hint{color:rgba(159,176,208,.8); font-weight:700; font-size:12px; line-height:1.5}
    .mission{
      border:1px solid rgba(21,32,55,.75);
      background:rgba(8,10,14,.55);
      border-radius:18px;
      padding:14px;
      margin-top:10px;
    }
    .mission b{display:block; font-size:16px; letter-spacing:.4px}
    .mission small{display:block; color:rgba(159,176,208,.85); font-weight:800; margin-top:4px}
    .mission .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .mission .actions .btn{padding:10px 12px; border-radius:14px}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(10,13,20,.92);
      border:1px solid rgba(99,163,255,.22);
      padding:12px 14px; border-radius:16px;
      box-shadow:var(--shadow);
      display:none; z-index:20;
      max-width:min(92vw,720px);
      font-weight:900;
    }
    .toast.show{display:block; animation:pop .18s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    .sep{height:1px; background:rgba(21,32,55,.75); margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <b>APEX • OFF-CHAIN MISSIONS (TEST)</b>
      <small>Tickets por missão usando localStorage (por wallet)</small>
    </div>
    <div class="row">
      <button class="btn primary" id="btnConnect">Connect Wallet</button>
      <button class="btn" id="btnDisconnect" style="display:none">Disconnect</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Wallet</h3>
      <div class="row">
        <div>
          <div class="hint">Address</div>
          <div class="mono" id="addr">—</div>
        </div>
        <div id="statusPill" class="pill no">NOT CONNECTED</div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div>
          <div class="hint">Tickets disponíveis</div>
          <div class="mono" style="font-size:22px;font-weight:1000" id="tickets">0</div>
        </div>
        <button class="btn primary" id="btnClaimExtra" disabled>Claim Extra Reward (TEST)</button>
      </div>
      <div class="hint" style="margin-top:10px">
        Esse “claim” é só teste: consome 1 ticket local. Em produção, vira um <b>claim separado</b> no contrato usando ticket assinado.
      </div>
    </div>

    <div class="card">
      <h3>Controles</h3>
      <div class="hint">
        ✅ Para marcar missão, você vai <b>assinar uma mensagem</b> na carteira. Isso prova que é a wallet, mas ainda é “off-chain”.
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn danger" id="btnReset" disabled>Reset Missões (wallet)</button>
        <button class="btn" id="btnExport" disabled>Export JSON</button>
      </div>
      <div class="hint" style="margin-top:10px">
        Export JSON é útil para você ver os tickets/missões no console ou enviar para um backend.
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>Missions</h3>

    <div class="mission" data-id="twitter_follow">
      <b>1) Follow Twitter (X)</b>
      <small>Abra o X e siga o perfil do projeto (teste).</small>
      <div class="actions">
        <a class="btn" href="https://x.com/" target="_blank" rel="noreferrer">Open X</a>
        <button class="btn primary btnVerify" disabled>Verify (Sign)</button>
        <span class="pill no pillState">PENDING</span>
      </div>
    </div>

    <div class="mission" data-id="telegram_join">
      <b>2) Join Telegram</b>
      <small>Entrar no grupo do Telegram (teste).</small>
      <div class="actions">
        <a class="btn" href="https://t.me/" target="_blank" rel="noreferrer">Open Telegram</a>
        <button class="btn primary btnVerify" disabled>Verify (Sign)</button>
        <span class="pill no pillState">PENDING</span>
      </div>
    </div>

    <div class="mission" data-id="retweet">
      <b>3) Retweet Post</b>
      <small>Retweet em um post do projeto (teste).</small>
      <div class="actions">
        <a class="btn" href="https://x.com/" target="_blank" rel="noreferrer">Open Post</a>
        <button class="btn primary btnVerify" disabled>Verify (Sign)</button>
        <span class="pill no pillState">PENDING</span>
      </div>
    </div>

    <div class="sep"></div>
    <div class="hint">
      ✅ Cada missão verificada libera <b>+1 ticket</b>. O botão “Claim Extra Reward” consome 1 ticket.
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
  const $ = (id)=>document.getElementById(id);

  // ---- STATE (localStorage per wallet) ----
  function keyFor(addr){ return `apex_missions_test_${addr?.toLowerCase() || "noaddr"}`; }

  function loadState(addr){
    try{
      return JSON.parse(localStorage.getItem(keyFor(addr))) || { tickets:0, missions:{} };
    }catch{ return { tickets:0, missions:{} }; }
  }
  function saveState(addr, st){
    localStorage.setItem(keyFor(addr), JSON.stringify(st));
  }

  // ---- UI helpers ----
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(t._t);
    t._t = setTimeout(()=>t.classList.remove("show"), 2600);
  }
  function shortAddr(a){ return a ? a.slice(0,6)+"…"+a.slice(-4) : "—"; }

  // ---- Web3 ----
  let provider, signer, address;

  async function connect(){
    if(!window.ethereum){
      toast("Sem carteira no navegador. Use MetaMask/Trust/OKX.");
      return;
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    address = await signer.getAddress();

    $("addr").textContent = address;
    $("statusPill").className = "pill ok";
    $("statusPill").textContent = "CONNECTED";

    $("btnConnect").style.display = "none";
    $("btnDisconnect").style.display = "inline-flex";

    // enable buttons
    document.querySelectorAll(".btnVerify").forEach(b=>b.disabled=false);
    $("btnReset").disabled = false;
    $("btnExport").disabled = false;

    refreshUI();
    toast("Wallet conectada ✅");
  }

  function disconnect(){
    provider=null; signer=null; address=null;
    $("addr").textContent = "—";
    $("statusPill").className = "pill no";
    $("statusPill").textContent = "NOT CONNECTED";
    $("btnConnect").style.display = "inline-flex";
    $("btnDisconnect").style.display = "none";
    document.querySelectorAll(".btnVerify").forEach(b=>b.disabled=true);
    $("btnReset").disabled = true;
    $("btnExport").disabled = true;
    $("btnClaimExtra").disabled = true;
    $("tickets").textContent = "0";
    // reset mission pills view
    document.querySelectorAll(".mission").forEach(m=>{
      m.querySelector(".pillState").className = "pill no pillState";
      m.querySelector(".pillState").textContent = "PENDING";
    });
  }

  function refreshUI(){
    if(!address) return;
    const st = loadState(address);

    $("tickets").textContent = String(st.tickets || 0);
    $("btnClaimExtra").disabled = !(st.tickets > 0);

    document.querySelectorAll(".mission").forEach(m=>{
      const id = m.getAttribute("data-id");
      const done = !!st.missions?.[id];
      const pill = m.querySelector(".pillState");
      if(done){
        pill.className = "pill ok pillState";
        pill.textContent = "VERIFIED";
      }else{
        pill.className = "pill no pillState";
        pill.textContent = "PENDING";
      }
    });
  }

  // ---- Verify Mission (TEST) ----
  async function verifyMission(missionId){
    if(!signer || !address){
      toast("Conecte a carteira primeiro.");
      return;
    }

    const st = loadState(address);
    if(st.missions?.[missionId]){
      toast("Essa missão já foi verificada.");
      return;
    }

    // message to sign (anti replay basic: include timestamp + missionId)
    const ts = Date.now();
    const msg =
`APEX MISSIONS TEST
wallet: ${address}
mission: ${missionId}
timestamp: ${ts}
I confirm I completed this mission (test only).`;

    try{
      const sig = await signer.signMessage(msg);

      // store locally as "ticket proof"
      st.missions = st.missions || {};
      st.missions[missionId] = {
        ts,
        sig,
        msgHash: ethers.keccak256(ethers.toUtf8Bytes(msg))
      };
      st.tickets = (st.tickets || 0) + 1;
      saveState(address, st);

      refreshUI();
      toast(`Missão verificada ✅ (+1 ticket)`);
    }catch(e){
      console.error(e);
      toast("Assinatura cancelada.");
    }
  }

  // ---- Claim Extra Reward (TEST) ----
  function claimExtraTest(){
    if(!address) return;
    const st = loadState(address);
    if(!(st.tickets > 0)){
      toast("Sem tickets.");
      return;
    }
    st.tickets -= 1;
    saveState(address, st);
    refreshUI();
    toast("Claim extra (TEST) ✅ Ticket consumido.");
  }

  // ---- Reset / Export ----
  function resetWallet(){
    if(!address) return;
    localStorage.removeItem(keyFor(address));
    refreshUI();
    toast("Resetado para essa wallet ✅");
  }

  function exportJSON(){
    if(!address) return;
    const st = loadState(address);
    console.log("MISSIONS EXPORT", { wallet: address, ...st });
    toast("Export feito (console) ✅");
  }

  // ---- Events ----
  $("btnConnect").addEventListener("click", connect);
  $("btnDisconnect").addEventListener("click", disconnect);
  $("btnReset").addEventListener("click", resetWallet);
  $("btnExport").addEventListener("click", exportJSON);
  $("btnClaimExtra").addEventListener("click", claimExtraTest);

  document.querySelectorAll(".mission").forEach(m=>{
    const id = m.getAttribute("data-id");
    m.querySelector(".btnVerify").addEventListener("click", ()=>verifyMission(id));
  });

</script>
</body>
</html>
