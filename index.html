<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>APEX ‚Ä¢ Missions + Mystery Box (Test)</title>

  <!-- Ethers (wallet + chain reads) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.14.0/dist/ethers.umd.min.js"></script>

  <!-- Firebase (compat p/ HTML √∫nico) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#05070b;
      --panel:#0b0f17;
      --panel2:#0a0d14;
      --card:#0b101a;
      --stroke:#152037;
      --text:#e9eefc;
      --muted:#9fb0d0;
      --muted2:#6e7fa7;
      --blue:#2d6cff;
      --blue2:#63a3ff;
      --green:#19d38b;
      --red:#ff4d4d;
      --amber:#ffcc66;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 18% 5%, rgba(45,108,255,.18), transparent 55%),
        radial-gradient(1000px 500px at 90% 18%, rgba(25,211,139,.10), transparent 60%),
        radial-gradient(1000px 500px at 70% 80%, rgba(255,77,77,.08), transparent 60%),
        linear-gradient(180deg, #04060a, #05070b 45%, #04060a);
      overflow-x:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(180deg, rgba(255,255,255,.03) 0px, rgba(255,255,255,.03) 1px, transparent 2px, transparent 6px);
      opacity:.06;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .wrap{max-width:1100px; margin:0 auto; padding: 16px 16px 80px;}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(4,6,10,.88), rgba(4,6,10,.55));
      border-bottom: 1px solid rgba(99,163,255,.15);
    }
    .topbar .inner{
      max-width:1100px; margin:0 auto; padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(20px 20px at 30% 30%, rgba(255,255,255,.25), transparent 70%),
                  linear-gradient(135deg, rgba(45,108,255,1), rgba(99,163,255,1));
      box-shadow: 0 12px 30px rgba(45,108,255,.22);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-30%;
      background: conic-gradient(from 130deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg);
      animation: shine 4.5s linear infinite;
      opacity:.35;
    }
    @keyframes shine{0%{transform:translateX(-25%) rotate(25deg)}100%{transform:translateX(25%) rotate(25deg)}}
    .brand h1{margin:0; font-size:18px; letter-spacing:.6px; font-weight:1000}
    .brand small{display:block; color:var(--muted2); font-weight:800; margin-top:2px}

    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .btn{
      border: 1px solid rgba(99,163,255,.25);
      background: rgba(11,16,26,.62);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 950;
      letter-spacing: .8px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:inline-flex; align-items:center; gap:10px;
      text-decoration:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(99,163,255,.45)}
    .btn.primary{background: linear-gradient(135deg, rgba(45,108,255,1), rgba(99,163,255,1)); border-color: transparent; box-shadow: 0 18px 45px rgba(45,108,255,.25);}
    .btn.ghost{background: rgba(8,10,14,.55)}
    .btn.danger{background: rgba(255,77,77,.10); border-color: rgba(255,77,77,.25)}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(21,32,55,.85);
      background: rgba(11,16,26,.55);
      color: rgba(233,238,252,.85);
      font-weight:950;
      letter-spacing:.6px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill.ok{border-color: rgba(25,211,139,.25); background: rgba(25,211,139,.08); color: rgba(25,211,139,.95)}
    .pill.warn{border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.08); color: rgba(255,204,102,.95)}
    .pill.bad{border-color: rgba(255,77,77,.25); background: rgba(255,77,77,.08); color: rgba(255,77,77,.95)}
    .hint{color: rgba(159,176,208,.82); font-weight:800; font-size:12px; line-height:1.5}

    .hero{
      padding: 18px 0 10px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
    }
    @media(max-width:920px){ .hero{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(11,16,26,.86), rgba(8,10,14,.82));
      border: 1px solid rgba(21,32,55,.75);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 260px at 20% 10%, rgba(45,108,255,.20), transparent 55%);
      pointer-events:none;
    }
    .title{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: 2px;
      color: rgba(159,176,208,.92);
      text-transform: uppercase;
      font-weight: 1000;
      position:relative;
    }
    .big{
      font-size: clamp(30px, 4vw, 52px);
      line-height: .98;
      margin: 10px 0 10px;
      font-weight: 1100;
      letter-spacing: 1px;
      position:relative;
    }
    .accent{color: var(--blue2)}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 14px;
    }
    .col6{grid-column: span 6;}
    .full{grid-column: 1 / -1;}
    @media(max-width:920px){
      .col6{grid-column: 1 / -1;}
    }

    .kv{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .k{
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(21,32,55,.75);
      background: rgba(8,10,14,.55);
      position:relative;
    }
    .k small{display:block; color: rgba(159,176,208,.85); font-weight:950; letter-spacing:1px}
    .k b{display:block; font-size:18px; margin-top:6px; letter-spacing:.6px}

    .mission{
      border:1px solid rgba(21,32,55,.75);
      background: rgba(8,10,14,.55);
      border-radius: 18px;
      padding: 14px;
      margin-top: 10px;
      position:relative;
    }
    .mission b{display:block; font-size:16px; font-weight:1100; letter-spacing:.4px}
    .mission small{display:block; color:rgba(159,176,208,.85); font-weight:850; margin-top:4px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    /* Mystery Box animation */
    .slot{
      margin-top:12px;
      border:1px solid rgba(21,32,55,.75);
      background: rgba(8,10,14,.55);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
    }
    .reel{
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
      overflow:hidden;
      border-radius: 14px;
      padding: 10px;
      border:1px solid rgba(21,32,55,.75);
      background: rgba(11,16,26,.50);
      position:relative;
      scroll-behavior:smooth;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(21,32,55,.75);
      background: rgba(8,10,14,.55);
      font-weight: 1100;
      letter-spacing:.4px;
      flex:0 0 auto;
      min-width: 190px;
      justify-content:space-between;
    }
    .chip .r{opacity:.95}
    .chip .p{opacity:.85; color: rgba(159,176,208,.9); font-weight:950}
    .chip.common{border-color: rgba(25,211,139,.22)}
    .chip.uncommon{border-color: rgba(99,163,255,.22)}
    .chip.rare{border-color: rgba(99,163,255,.40)}
    .chip.epic{border-color: rgba(190,120,255,.35)}
    .chip.legend{border-color: rgba(255,204,102,.35)}
    .chip.supreme{border-color: rgba(255,77,77,.35)}
    .glow{
      position:absolute; inset:0;
      pointer-events:none;
      background: radial-gradient(320px 120px at 50% 50%, rgba(99,163,255,.15), transparent 60%);
      opacity:.8;
    }
    .result{
      margin-top: 12px;
      padding: 14px;
      border-radius: 18px;
      border:1px solid rgba(21,32,55,.75);
      background: rgba(8,10,14,.55);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,13,20,.92);
      border:1px solid rgba(99,163,255,.22);
      color: rgba(233,238,252,.92);
      padding: 12px 14px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 120;
      max-width: min(92vw, 780px);
      font-weight:950;
      letter-spacing:.4px;
    }
    .toast.show{display:block; animation: pop .2s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:0}to{transform:translateX(-50%) translateY(0); opacity:1}}

    footer{
      opacity:.85;
      border-top: 1px solid rgba(21,32,55,.55);
      margin-top: 22px;
      padding-top: 18px;
      color: rgba(159,176,208,.78);
      font-weight:900;
      letter-spacing:1px;
      text-align:center;
    }
    table td, table th {border:none}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>APEX PROJECT ‚Ä¢ Test Suite</h1>
          <small>Missions + Mystery Box + Ranking (Firebase)</small>
        </div>
      </div>

      <div class="row">
        <span class="pill" id="pillChain">BSC 56</span>
        <button class="btn primary" id="btnConnect" type="button">CONNECT WALLET</button>
        <button class="btn ghost" id="btnDisconnect" type="button" style="display:none">DISCONNECT</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <section class="hero">
      <div class="card">
        <div class="title">THE APEX OF <span class="accent">WEB3</span></div>
        <div class="big">Missions +<br><span class="accent">Mystery Box</span></div>
        <div class="hint">
          Este site √© um <b>teste realista</b>: miss√µes, tickets, jackpot e ranking no Firebase.
          Recompensa on-chain ser√° adicionada depois (contrato ticket assinado).
        </div>

        <div class="row" style="margin-top:12px">
          <span class="pill" id="pillFb">Firebase: drama-damas</span>
          <span class="pill warn" id="pillMode">MODE: TEST</span>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnSeedDemo" type="button">Seed Demo (Jackpot/Pool)</button>
          <button class="btn danger" id="btnResetWalletData" type="button" disabled>Reset Wallet (Firebase)</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Dica: se aparecer ‚ÄúInstall MetaMask‚Äù, abra dentro do navegador de uma carteira Web3.
        </div>
      </div>

      <div class="card">
        <div class="title">HOLDER DASHBOARD</div>

        <div class="kv">
          <div class="k">
            <small>WALLET</small>
            <b class="mono" id="walletAddr">Desconectado</b>
          </div>
          <div class="k">
            <small>TICKETS</small>
            <b class="mono" id="tickets">0</b>
            <div class="hint">Tickets v√™m das miss√µes e servem para abrir caixas.</div>
          </div>
        </div>

        <div class="kv" style="margin-top:10px">
          <div class="k">
            <small>BNB (real)</small>
            <b class="mono" id="balBNB">‚Äî</b>
          </div>
          <div class="k">
            <small>APEX (real)</small>
            <b class="mono" id="balAPEX">‚Äî</b>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="badgeHolder">HOLDER</span>
          <span class="pill" id="badgeWhale">WHALE</span>
          <span class="pill" id="badgeReady">READY</span>
        </div>

        <div class="hint" style="margin-top:10px" id="status">Pronto.</div>
      </div>
    </section>

    <section class="grid">
      <div class="card col6" id="missions">
        <div class="title">MISSIONS (OFF-CHAIN)</div>
        <div class="hint">Cada miss√£o verificada libera <b>+1 ticket</b> (salvo no Firestore por wallet).</div>

        <div class="mission" data-id="twitter_follow">
          <b>1) Follow Twitter (X)</b>
          <small>Abra o X e siga o perfil do projeto (teste). ‚Äî <span class="mono">+1 Ticket</span></small>
          <div class="actions">
            <a class="btn ghost" href="https://x.com/" target="_blank" rel="noreferrer">Open X</a>
            <button class="btn primary btnVerify" type="button" disabled>Verify (Sign)</button>
            <span class="pill" data-pill>Pending</span>
          </div>
        </div>

        <div class="mission" data-id="telegram_join">
          <b>2) Join Telegram</b>
          <small>Entrar no Telegram (teste). ‚Äî <span class="mono">+1 Ticket</span></small>
          <div class="actions">
            <a class="btn ghost" href="https://t.me/+mqb5YzltX6piOGFh" target="_blank" rel="noreferrer">Open Telegram</a>
            <button class="btn primary btnVerify" type="button" disabled>Verify (Sign)</button>
            <span class="pill" data-pill>Pending</span>
          </div>
        </div>

        <div class="mission" data-id="retweet">
          <b>3) Retweet</b>
          <small>Retweet em um post (teste). ‚Äî <span class="mono">+1 Ticket</span></small>
          <div class="actions">
            <a class="btn ghost" href="https://x.com/" target="_blank" rel="noreferrer">Open Post</a>
            <button class="btn primary btnVerify" type="button" disabled>Verify (Sign)</button>
            <span class="pill" data-pill>Pending</span>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnReload" type="button" disabled>Reload Firebase</button>
          <span class="hint">Sem ‚Äúpermission_denied‚Äù = rules ok.</span>
        </div>
      </div>

      <div class="card col6" id="box">
        <div class="title">MYSTERY BOX (CASINO STYLE)</div>
        <div class="hint">
          No teste, abrir caixa <b>consome tickets</b> e gera recompensa simulada (salva no Firebase + ranking).
          Depois viramos isso em <b>claim on-chain</b>.
        </div>

        <div class="kv" style="margin-top:10px">
          <div class="k">
            <small>JACKPOT (global)</small>
            <b class="mono" id="jackpot">‚Äî</b>
          </div>
          <div class="k">
            <small>POOL (simulado)</small>
            <b class="mono" id="pool">‚Äî</b>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnBoxNormal" type="button" disabled>Normal (1 Ticket)</button>
          <button class="btn" id="btnBoxPremium" type="button" disabled>Premium (3 Tickets)</button>
          <button class="btn" id="btnBoxWhale" type="button" disabled>Whale (5 Tickets)</button>
        </div>

        <div class="hint" style="margin-top:8px">
          Whale precisa ter ‚â• <span class="mono">1,000,000 APEX</span> (real).  
          Burn simulado: <span class="mono">2%</span> ‚Ä¢ Jackpot: <span class="mono">2%</span> ‚Ä¢ Marketing: <span class="mono">3%</span>
        </div>

        <div class="slot">
          <div class="reel" id="reel">
            <div class="glow"></div>
          </div>
          <div class="result">
            <div>
              <div class="hint">Resultado</div>
              <div style="font-weight:1100;font-size:18px" id="resultText">‚Äî</div>
              <div class="hint mono" id="resultMeta">‚Äî</div>
            </div>
            <span class="pill" id="rarityPill">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="card full" id="ranking">
        <div class="title">RANKING (TOP 10)</div>
        <div class="hint">
          Pontos: +1 por miss√£o conclu√≠da, +1 por caixa aberta, + b√¥nus por raridade.
        </div>

        <div class="kv" style="margin-top:10px">
          <div class="k">
            <small>SEU SCORE</small>
            <b class="mono" id="myScore">‚Äî</b>
          </div>
          <div class="k">
            <small>SEU TOTAL WON (sim)</small>
            <b class="mono" id="myWon">‚Äî</b>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto; border-radius:18px; border:1px solid rgba(21,32,55,.75); background:rgba(8,10,14,.55)">
          <table style="width:100%; border-collapse:collapse; min-width:720px">
            <thead>
              <tr style="text-align:left; color:rgba(159,176,208,.92); letter-spacing:2px; font-weight:1000; font-size:12px; text-transform:uppercase">
                <th style="padding:12px">#</th>
                <th style="padding:12px">Wallet</th>
                <th style="padding:12px">Score</th>
                <th style="padding:12px">Boxes</th>
                <th style="padding:12px">Won (sim)</th>
                <th style="padding:12px">Last</th>
              </tr>
            </thead>
            <tbody id="rankBody" style="font-weight:900; color:rgba(233,238,252,.92)"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnRank" type="button">Atualizar Ranking</button>
          <span class="hint">Ranking vem do Firestore (collection: leaderboard).</span>
        </div>
      </div>
    </section>

    <footer>
      ¬© 2026 APEX ‚Ä¢ Test Site (Firebase). Produ√ß√£o: integrar ticket assinado + claim on-chain.
    </footer>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
   ========================= */

// BSC RPC (reads)
const RPC_BSC = "https://bsc-dataseed.binance.org/";
const CHAIN_ID = 56;

// APEX token (real)
const APEX = {
  address: "0xB3a78c3f55Fc653992169F77cb10878D2cF1684f",
  abi: [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function symbol() view returns (string)"
  ]
};

// Whale gate (real balance)
const WHALE_MIN = 1_000_000;

// Mystery Box economics (simulated)
const ECON = {
  burnPct: 0.02,       // 2%
  jackpotPct: 0.02,    // 2%
  marketingPct: 0.03,  // 3%
  // pool protection thresholds (sim)
  poolLow1: 10_000_000_000, // 10B
  poolLow2: 5_000_000_000   // 5B
};

// Chance tables (base). If pool low, we reduce rare chances dynamically.
const CHANCES = {
  normal: [
    { key:"common",   label:"üü¢ Comum",   p:75.0,   reward:500 },
    { key:"uncommon", label:"üü¢ Incomum", p:20.0,   reward:1299 },
    { key:"rare",     label:"üîµ Raro",    p:4.0,    reward:5000 },
    { key:"epic",     label:"üü£ √âpico",   p:0.8,    reward:20000 },
    { key:"legend",   label:"üü° Lend√°rio",p:0.15,   reward:100000 },
    { key:"supreme",  label:"üî• Supremo", p:0.05,   reward:500000 }
  ],
  premium: [
    { key:"common",   label:"üü¢ Comum",   p:55.0,   reward:1000 },
    { key:"uncommon", label:"üü¢ Incomum", p:30.0,   reward:3000 },
    { key:"rare",     label:"üîµ Raro",    p:10.0,   reward:10000 },
    { key:"epic",     label:"üü£ √âpico",   p:3.0,    reward:50000 },
    { key:"legend",   label:"üü° Lend√°rio",p:1.8,    reward:150000 },
    { key:"supreme",  label:"üî• Supremo", p:0.2,    reward:750000 }
  ],
  whale: [
    { key:"common",   label:"üü¢ Comum",   p:40.0,   reward:2000 },
    { key:"uncommon", label:"üü¢ Incomum", p:30.0,   reward:5000 },
    { key:"rare",     label:"üîµ Raro",    p:15.0,   reward:25000 },
    { key:"epic",     label:"üü£ √âpico",   p:8.0,    reward:100000 },
    { key:"legend",   label:"üü° Lend√°rio",p:6.0,    reward:300000 },
    { key:"supreme",  label:"üî• Supremo", p:1.0,    reward:1000000 }
  ]
};

// Ticket costs per box type
const BOX_COST = { normal:1, premium:3, whale:5 };

// Cooldown per open (anti-bot basic, seconds)
const BOX_COOLDOWN = 8;

/* =========================
   FIREBASE (drama-damas)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAwBLS4cFrTvM6rbXpn968B752RlarNnVc",
  authDomain: "drama-damas.firebaseapp.com",
  databaseURL: "https://drama-damas-default-rtdb.firebaseio.com",
  projectId: "drama-damas",
  storageBucket: "drama-damas.firebasestorage.app",
  messagingSenderId: "932787134552",
  appId: "1:932787134552:web:86a275650e75434f662a2d",
  measurementId: "G-LXCBBGBML6"
};

let auth, db;

/* =========================
   WEB3
   ========================= */
let injectedProvider;
let browserProvider;
let signer;
let userAddress = null;

let apexDecimals = 18;
let apexSymbol = "APEX";
let apexContract;
let readProvider;

/* =========================
   UI helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.classList.remove("show"), 2600);
};
const setStatus = (msg)=> $("status").textContent = msg;
const shortAddr = (a)=> a ? a.slice(0,6)+"‚Ä¶"+a.slice(-4) : "‚Äî";

function fmt(n, dp=4){
  if(n === null || n === undefined || !isFinite(Number(n))) return "‚Äî";
  return new Intl.NumberFormat("en-US", {maximumFractionDigits: dp}).format(Number(n));
}

/* =========================
   Firebase init + auth
   ========================= */
function initFirebase(){
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
}

async function anonLogin(){
  await auth.signInAnonymously();
}

/* =========================
   Firestore refs
   ========================= */
function missionsRef(addr){ return db.collection("missions").doc(addr.toLowerCase()); }
function leaderRef(addr){ return db.collection("leaderboard").doc(addr.toLowerCase()); }
function globalRef(){ return db.collection("global").doc("economy"); }

async function seedDemoEconomy(){
  await db.runTransaction(async (tx)=>{
    const ref = globalRef();
    const snap = await tx.get(ref);
    if(snap.exists) return;
    tx.set(ref, {
      jackpot: 25000,
      pool: 12_500_000_000,
      burned: 0,
      marketing: 0,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  });
  toast("Economy demo seeded ‚úÖ");
  await loadEconomy();
}

async function loadEconomy(){
  const snap = await globalRef().get();
  if(!snap.exists){
    $("jackpot").textContent = "‚Äî";
    $("pool").textContent = "‚Äî";
    return null;
  }
  const d = snap.data();
  $("jackpot").textContent = fmt(d.jackpot ?? 0, 0) + " APEX";
  $("pool").textContent = fmt(d.pool ?? 0, 0) + " APEX";
  return d;
}

/* =========================
   Wallet connect (Injected)
   ========================= */
async function connectWallet(){
  try{
    setStatus("Conectando‚Ä¶");
    if(!window.ethereum){
      toast("Sem carteira no navegador. Use MetaMask/Trust/OKX (browser).");
      setStatus("Sem wallet injetada.");
      return;
    }

    await anonLogin();

    injectedProvider = window.ethereum;
    browserProvider = new ethers.BrowserProvider(injectedProvider, "any");
    await browserProvider.send("eth_requestAccounts", []);
    signer = await browserProvider.getSigner();
    userAddress = await signer.getAddress();

    $("walletAddr").textContent = userAddress;
    $("btnConnect").style.display = "none";
    $("btnDisconnect").style.display = "inline-flex";
    $("btnResetWalletData").disabled = false;

    document.querySelectorAll(".btnVerify").forEach(b=>b.disabled=false);
    $("btnReload").disabled = false;

    readProvider = new ethers.JsonRpcProvider(RPC_BSC);
    apexContract = new ethers.Contract(APEX.address, APEX.abi, readProvider);

    try{
      apexDecimals = Number(await apexContract.decimals());
      apexSymbol = await apexContract.symbol();
    }catch(e){}

    toast("Wallet conectada ‚úÖ");
    setStatus("Carregando dados‚Ä¶");
    await refreshAll();
  }catch(e){
    console.error(e);
    toast("Conex√£o cancelada ou falhou.");
    setStatus("Falhou ao conectar.");
  }
}

function disconnectWallet(){
  userAddress = null;
  signer = null;
  browserProvider = null;
  injectedProvider = null;

  $("walletAddr").textContent = "Desconectado";
  $("tickets").textContent = "0";
  $("balBNB").textContent = "‚Äî";
  $("balAPEX").textContent = "‚Äî";
  $("myScore").textContent = "‚Äî";
  $("myWon").textContent = "‚Äî";

  $("btnConnect").style.display = "inline-flex";
  $("btnDisconnect").style.display = "none";

  document.querySelectorAll(".btnVerify").forEach(b=>b.disabled=true);
  $("btnReload").disabled = true;
  $("btnResetWalletData").disabled = true;

  $("btnBoxNormal").disabled = true;
  $("btnBoxPremium").disabled = true;
  $("btnBoxWhale").disabled = true;

  document.querySelectorAll("[data-pill]").forEach(p=>{
    p.className = "pill";
    p.textContent = "Pending";
  });

  setStatus("Desconectado.");
}

/* =========================
   On-chain balances (real)
   ========================= */
async function refreshBalances(){
  if(!userAddress) return;

  try{
    const b = await browserProvider.getBalance(userAddress);
    $("balBNB").textContent = fmt(ethers.formatEther(b), 6);
  }catch(e){
    $("balBNB").textContent = "‚Äî";
  }

  try{
    const bal = await apexContract.balanceOf(userAddress);
    const n = Number(ethers.formatUnits(bal, apexDecimals));
    $("balAPEX").textContent = fmt(n, 4);

    $("badgeHolder").className = (n >= 1) ? "pill ok" : "pill";
    $("badgeHolder").textContent = "HOLDER";

    const isWhale = n >= WHALE_MIN;
    $("badgeWhale").className = isWhale ? "pill warn" : "pill";
    $("badgeWhale").textContent = "WHALE";

    $("badgeReady").className = "pill ok";
    $("badgeReady").textContent = "READY";

    updateBoxButtons();
  }catch(e){
    console.warn(e);
  }
}

/* =========================
   Missions + tickets (Firestore)
   ========================= */
async function loadWalletData(){
  if(!userAddress) return null;
  const ref = missionsRef(userAddress);
  const snap = await ref.get();
  if(!snap.exists){
    const init = {
      wallet: userAddress.toLowerCase(),
      tickets: 0,
      missions: {},
      score: 0,
      boxes: 0,
      wonTotal: 0,
      lastOpenAt: 0,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(init, {merge:true});
    return init;
  }
  return snap.data();
}

function renderWalletData(d){
  const tickets = Number(d?.tickets || 0);
  $("tickets").textContent = String(tickets);

  const missions = d?.missions || {};
  document.querySelectorAll(".mission").forEach(m=>{
    const id = m.getAttribute("data-id");
    const pill = m.querySelector("[data-pill]");
    const done = !!missions[id];
    if(done){
      pill.className = "pill ok";
      pill.textContent = "Verified";
    }else{
      pill.className = "pill";
      pill.textContent = "Pending";
    }
  });

  $("myScore").textContent = fmt(d?.score ?? 0, 0);
  $("myWon").textContent = fmt(d?.wonTotal ?? 0, 0) + " APEX";

  updateBoxButtons();
}

async function verifyMission(missionId){
  if(!userAddress || !signer) return toast("Conecte a wallet primeiro.");

  const ts = Date.now();
  const msg = `APEX Mission Verify (TEST)\nwallet:${userAddress}\nmission:${missionId}\nts:${ts}`;
  try{
    await signer.signMessage(msg);
  }catch(e){
    return toast("Assinatura cancelada.");
  }

  setStatus("Salvando miss√£o‚Ä¶");

  await db.runTransaction(async (tx)=>{
    const ref = missionsRef(userAddress);
    const snap = await tx.get(ref);
    const d = snap.exists ? snap.data() : {tickets:0, missions:{}, score:0, boxes:0, wonTotal:0, lastOpenAt:0};

    if(d.missions?.[missionId]) return;

    const missions = d.missions || {};
    missions[missionId] = true;

    const tickets = Number(d.tickets || 0) + 1;
    const score = Number(d.score || 0) + 1;

    tx.set(ref, {
      wallet: userAddress.toLowerCase(),
      missions,
      tickets,
      score,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  });

  await bumpLeaderboard({scoreDelta: 1});

  toast("Miss√£o verificada ‚úÖ +1 ticket");
  await refreshAll();
}

async function resetWalletFirebase(){
  if(!userAddress) return;
  await missionsRef(userAddress).delete().catch(()=>{});
  await leaderRef(userAddress).delete().catch(()=>{});
  toast("Wallet resetada no Firebase ‚úÖ");
  await refreshAll();
}

/* =========================
   Box logic (simulated)
   ========================= */
function buildReelVisual(type){
  const reel = $("reel");
  reel.querySelectorAll(".chip").forEach(n=>n.remove());

  const base = CHANCES[type];
  const chips = [];
  for(let i=0;i<18;i++){
    const it = base[i % base.length];
    chips.push(it);
  }
  chips.sort(()=>Math.random()-0.5);

  for(const it of chips){
    const div = document.createElement("div");
    div.className = `chip ${it.key}`;
    div.innerHTML = `<span class="r">${it.label}</span><span class="p">${it.reward.toLocaleString()} APEX</span>`;
    reel.appendChild(div);
  }
}

function rarityClass(key){
  if(key==="common") return "pill ok";
  if(key==="uncommon") return "pill";
  if(key==="rare") return "pill warn";
  if(key==="epic") return "pill warn";
  if(key==="legend") return "pill warn";
  if(key==="supreme") return "pill bad";
  return "pill";
}

function rarityBonus(key){
  if(key==="rare") return 2;
  if(key==="epic") return 5;
  if(key==="legend") return 12;
  if(key==="supreme") return 25;
  return 1;
}

function applyPoolProtection(table, pool){
  const copy = table.map(x=>({...x}));
  let factor = 1.0;
  if(pool !== null && pool !== undefined){
    if(pool < ECON.poolLow2) factor = 0.5;
    else if(pool < ECON.poolLow1) factor = 0.7;
  }
  if(factor === 1.0) return normalize(copy);

  const rareKeys = new Set(["epic","legend","supreme"]);
  let removed = 0;

  for(const it of copy){
    if(rareKeys.has(it.key)){
      const old = it.p;
      it.p = old * factor;
      removed += (old - it.p);
    }
  }
  const common = copy.find(x=>x.key==="common");
  if(common) common.p += removed;

  return normalize(copy);
}

function normalize(table){
  const s = table.reduce((a,b)=>a + b.p, 0);
  if(Math.abs(s-100) < 1e-9) return table;
  return table.map(it=>({ ...it, p: (it.p / s) * 100 }));
}

function pickFromChances(table){
  const r = Math.random() * 100;
  let acc = 0;
  for(const it of table){
    acc += it.p;
    if(r <= acc) return it;
  }
  return table[table.length - 1];
}

async function openBox(type){
  if(!userAddress) return toast("Conecte a wallet.");
  setStatus("Verificando tickets‚Ä¶");

  const d = await loadWalletData();
  const tickets = Number(d?.tickets || 0);
  const cost = BOX_COST[type];

  const nowS = Math.floor(Date.now()/1000);
  const last = Number(d?.lastOpenAt || 0);
  if(last && (nowS - last) < BOX_COOLDOWN){
    return toast(`Aguarde ${BOX_COOLDOWN - (nowS-last)}s (anti-bot).`);
  }

  if(type === "whale"){
    const bal = await apexContract.balanceOf(userAddress);
    const n = Number(ethers.formatUnits(bal, apexDecimals));
    if(n < WHALE_MIN){
      return toast(`Whale Box precisa ‚â• ${WHALE_MIN.toLocaleString()} APEX.`);
    }
  }

  if(tickets < cost){
    return toast(`Sem tickets suficientes. Precisa de ${cost} ticket(s).`);
  }

  const econ = await loadEconomy() || {jackpot:0, pool:0, burned:0, marketing:0};
  let pool = Number(econ.pool || 0);
  let jackpot = Number(econ.jackpot || 0);

  buildReelVisual(type);

  const reel = $("reel");
  reel.scrollLeft = 0;
  setStatus("Abrindo caixa‚Ä¶");
  $("resultText").textContent = "üé∞ Spinning‚Ä¶";
  $("resultMeta").textContent = "‚Äî";
  $("rarityPill").textContent = "‚Äî";
  $("rarityPill").className = "pill";

  const spinMs = 1600 + Math.floor(Math.random()*700);
  const start = performance.now();
  const targetScroll = 900 + Math.floor(Math.random()*700);

  await new Promise((resolve)=>{
    const tick = (t)=>{
      const p = Math.min(1, (t-start)/spinMs);
      const ease = 1 - Math.pow(1-p, 3);
      reel.scrollLeft = targetScroll * ease;
      if(p < 1) requestAnimationFrame(tick);
      else resolve();
    };
    requestAnimationFrame(tick);
  });

  const table = applyPoolProtection(CHANCES[type], pool);
  const win = pickFromChances(table);

  const price = (type==="normal") ? 1500 : (type==="premium") ? 5000 : 10000;
  const burn = Math.floor(price * ECON.burnPct);
  const jAdd = Math.floor(price * ECON.jackpotPct);
  const mAdd = Math.floor(price * ECON.marketingPct);

  jackpot += jAdd;
  pool += (price - burn - jAdd - mAdd);

  let payout = win.reward;

  let jackpotWon = 0;
  if(win.key === "supreme"){
    jackpotWon = jackpot;
    payout += jackpotWon;
    jackpot = 0;
  }

  pool = Math.max(pool - payout, 0);

  const bonus = rarityBonus(win.key);
  await db.runTransaction(async (tx)=>{
    const ref = missionsRef(userAddress);
    const snap = await tx.get(ref);
    const d2 = snap.exists ? snap.data() : {tickets:0, score:0, boxes:0, wonTotal:0};

    const newTickets = Math.max(Number(d2.tickets||0) - cost, 0);
    const newScore = Number(d2.score||0) + 1 + bonus;
    const newBoxes = Number(d2.boxes||0) + 1;
    const newWon = Number(d2.wonTotal||0) + payout;

    tx.set(ref, {
      tickets: newTickets,
      score: newScore,
      boxes: newBoxes,
      wonTotal: newWon,
      lastOpenAt: nowS,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  });

  await db.runTransaction(async (tx)=>{
    const ref = globalRef();
    const snap = await tx.get(ref);
    const cur = snap.exists ? snap.data() : {jackpot:0, pool:0, burned:0, marketing:0};

    tx.set(ref, {
      jackpot,
      pool,
      burned: Number(cur.burned||0) + burn,
      marketing: Number(cur.marketing||0) + mAdd,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  });

  await bumpLeaderboard({scoreDelta: 1 + bonus, boxesDelta: 1, wonDelta: payout, lastText: win.label});

  $("resultText").textContent = `${win.label} ‚Ä¢ Voc√™ ganhou ${payout.toLocaleString()} APEX (sim)`;
  const metaParts = [
    `Box: ${type.toUpperCase()}`,
    `Cost: ${cost} ticket(s)`,
    `Burn: ${burn} | Jackpot+: ${jAdd} | MKT: ${mAdd}`
  ];
  if(jackpotWon > 0) metaParts.push(`JACKPOT WON: ${jackpotWon.toLocaleString()} APEX`);
  $("resultMeta").textContent = metaParts.join(" ‚Ä¢ ");

  $("rarityPill").className = rarityClass(win.key);
  $("rarityPill").textContent = win.key.toUpperCase();

  toast("Caixa aberta ‚úÖ");
  setStatus("Atualizado ‚úÖ");

  await refreshAll();
}

/* =========================
   Leaderboard
   ========================= */
async function bumpLeaderboard({scoreDelta=0, boxesDelta=0, wonDelta=0, lastText=""}){
  if(!userAddress) return;
  await db.runTransaction(async (tx)=>{
    const ref = leaderRef(userAddress);
    const snap = await tx.get(ref);
    const d = snap.exists ? snap.data() : {score:0, boxes:0, wonTotal:0};

    tx.set(ref, {
      wallet: userAddress.toLowerCase(),
      score: Number(d.score||0) + scoreDelta,
      boxes: Number(d.boxes||0) + boxesDelta,
      wonTotal: Number(d.wonTotal||0) + wonDelta,
      last: lastText || d.last || "",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  });
}

async function loadLeaderboard(){
  const qs = await db.collection("leaderboard").orderBy("score", "desc").limit(10).get();
  const tbody = $("rankBody");
  tbody.innerHTML = "";

  let i = 1;
  qs.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement("tr");
    tr.style.borderTop = "1px solid rgba(21,32,55,.55)";
    tr.innerHTML = `
      <td style="padding:12px; color:rgba(159,176,208,.92)">${i++}</td>
      <td style="padding:12px" class="mono">${shortAddr(d.wallet || "")}</td>
      <td style="padding:12px">${fmt(d.score||0,0)}</td>
      <td style="padding:12px">${fmt(d.boxes||0,0)}</td>
      <td style="padding:12px" class="mono">${fmt(d.wonTotal||0,0)}</td>
      <td style="padding:12px; color:rgba(159,176,208,.9)">${(d.last || "‚Äî")}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   Box buttons enable/disable
   ========================= */
function updateBoxButtons(){
  const tickets = Number($("tickets").textContent || 0);

  const bN = $("btnBoxNormal");
  const bP = $("btnBoxPremium");
  const bW = $("btnBoxWhale");

  const connected = !!userAddress;

  bN.disabled = !(connected && tickets >= BOX_COST.normal);
  bP.disabled = !(connected && tickets >= BOX_COST.premium);

  let whaleOk = false;
  try{
    const v = $("balAPEX").textContent;
    const n = Number(String(v).replaceAll(",",""));
    whaleOk = isFinite(n) && (n >= WHALE_MIN);
  }catch(e){}
  bW.disabled = !(connected && tickets >= BOX_COST.whale && whaleOk);
}

/* =========================
   Refresh all
   ========================= */
async function refreshAll(){
  await loadEconomy();

  if(userAddress){
    await refreshBalances();
    const d = await loadWalletData();
    renderWalletData(d);
  }

  await loadLeaderboard();
  setStatus("Pronto ‚úÖ");
}

/* =========================
   Wire UI events
   ========================= */
function bindUI(){
  $("btnConnect").onclick = connectWallet;
  $("btnDisconnect").onclick = disconnectWallet;

  $("btnSeedDemo").onclick = async ()=>{ await seedDemoEconomy(); };

  $("btnReload").onclick = refreshAll;

  $("btnResetWalletData").onclick = resetWalletFirebase;

  document.querySelectorAll(".mission").forEach(m=>{
    const id = m.getAttribute("data-id");
    m.querySelector(".btnVerify").onclick = ()=>verifyMission(id);
  });

  $("btnBoxNormal").onclick  = ()=>openBox("normal");
  $("btnBoxPremium").onclick = ()=>openBox("premium");
  $("btnBoxWhale").onclick   = ()=>openBox("whale");

  $("btnRank").onclick = loadLeaderboard;
}

/* =========================
   Boot
   ========================= */
(async function boot(){
  initFirebase();
  bindUI();

  try{
    await anonLogin();
  }catch(e){
    console.warn(e);
    toast("Ative Anonymous Auth no Firebase.");
  }

  await loadEconomy();
  await loadLeaderboard();
  buildReelVisual("normal");
})();
</script>
</body>
</html>
